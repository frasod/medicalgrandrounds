<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Grand Rounds - Nationwide Livestreaming</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        header, footer { text-align: center; margin-bottom: 20px; }
        .filters { background-color: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .filters select, .filters input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .filters .checkbox-group { display: flex; align-items: center; gap: 5px; }
        .event-card { border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
        .event-card.livestream { border-left: 4px solid #0066cc; background-color: #f8fbff; }
        .event-card h3 { margin-top: 0; padding-right: 100px; }
        .event-card .institution { font-weight: bold; color: #555; }
        .event-card .details { font-size: 0.9em; color: #777; line-height: 1.8; }
        .event-card .links a { margin-right: 15px; text-decoration: none; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-right: 8px; }
        .badge.livestream { background-color: #0066cc; color: white; }
        .badge.zoom { background-color: #2d8cff; color: white; }
        .badge.cme { background-color: #28a745; color: white; }
        .format-info { margin-top: 8px; padding: 8px; background-color: #e8f4ff; border-radius: 4px; font-size: 0.85em; }
        .zoom-info { margin-top: 5px; font-family: monospace; font-size: 0.85em; color: #0066cc; }
        .livestream-badge-corner { position: absolute; top: 15px; right: 15px; background-color: #ff4444; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.75em; font-weight: bold; }
    </style>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="{
    events: [],
    loading: true,
    stateFilter: '',
    searchTerm: '',
    livestreamOnly: false,

    init() {
        fetch('data.json')
            .then(r => r.json())
            .then(d => {
                this.events = d.events || [];
                this.loading = false;
                console.log('Loaded', this.events.length, 'events');
            })
            .catch(e => {
                console.error('Error:', e);
                this.loading = false;
            });
    },

    formatDate(dateStr) {
        if (!dateStr) return 'Date TBA';

        // Handle recurring events
        if (dateStr.includes('Recurring') || dateStr.includes('Weekly') || dateStr.includes('Regular')) {
            return dateStr;
        }

        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;

            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
            const day = date.getDate();
            const suffix = day === 1 || day === 21 || day === 31 ? 'st' :
                          day === 2 || day === 22 ? 'nd' :
                          day === 3 || day === 23 ? 'rd' : 'th';

            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            const displayMinutes = minutes.toString().padStart(2, '0');

            return `${months[date.getMonth()]} ${day}${suffix}, ${date.getFullYear()} at ${displayHours}:${displayMinutes} ${ampm}`;
        } catch (e) {
            return dateStr;
        }
    },

    isWithinNextMonth(dateStr) {
        // Keep recurring events
        if (dateStr.includes('Recurring') || dateStr.includes('Weekly') || dateStr.includes('Regular')) {
            return true;
        }

        try {
            const eventDate = new Date(dateStr);
            if (isNaN(eventDate.getTime())) return true; // Keep if can't parse

            const now = new Date();
            const oneMonthFromNow = new Date();
            oneMonthFromNow.setMonth(oneMonthFromNow.getMonth() + 1);

            return eventDate >= now && eventDate <= oneMonthFromNow;
        } catch (e) {
            return true; // Keep if error parsing
        }
    },

    get filteredEvents() {
        let result = this.events;

        // Show only future events
        const now = new Date();
        result = result.filter(e => {
            const dt = e.date_time;
            // Always show recurring events
            if (dt.includes('Recurring') || dt.includes('Weekly') || dt.includes('Mondays') || 
                dt.includes('Fridays') || dt.includes('Thursdays') || dt.includes('Regular') || dt.includes('Contact')) {
                return true;
            }
            try {
                const eventDate = new Date(dt);
                return !isNaN(eventDate.getTime()) && eventDate >= now;
            } catch {
                return false;
            }
        });

        if (this.livestreamOnly) {
            result = result.filter(e => e.livestream_available === true);
        }

        if (this.stateFilter) {
            result = result.filter(e => e.state === this.stateFilter);
        }

        if (this.searchTerm && this.searchTerm.length > 2) {
            const term = this.searchTerm.toLowerCase();
            result = result.filter(e =>
                (e.title && e.title.toLowerCase().includes(term)) ||
                (e.institution && e.institution.toLowerCase().includes(term)) ||
                (e.speaker && e.speaker.toLowerCase().includes(term))
            );
        }

        return result;
    },

    get states() {
        return [...new Set(this.events.map(e => e.state))].sort();
    }
}">
    <header>
        <h1>ðŸŽ¥ Medical Grand Rounds - Nationwide Livestreaming</h1>
        <p>Attend grand rounds from top medical centers across the country - all from your computer</p>
        <p style="font-size: 0.9em; color: #666;">Featuring Johns Hopkins, Duke, Mayo Clinic, University of Utah, Wisconsin, MUSC, and more</p>
    </header>

    <div class="filters">
        <select x-model="stateFilter">
            <option value="">All States</option>
            <template x-for="state in states">
                <option :value="state" x-text="state"></option>
            </template>
        </select>
        <input type="text" x-model="searchTerm" placeholder="Search...">
        <div class="checkbox-group">
            <input type="checkbox" id="livestream-only" x-model="livestreamOnly">
            <label for="livestream-only">ðŸŽ¥ Livestream Only</label>
        </div>
        <span x-text="'(' + filteredEvents.length + ' events)'"></span>
    </div>

    <div x-show="loading">Loading events...</div>

    <main x-show="!loading">
        <template x-for="event in filteredEvents" :key="event.title + event.date_time">
            <div class="event-card" :class="{ 'livestream': event.livestream_available }">
                <div x-show="event.livestream_available" class="livestream-badge-corner">ðŸ”´ LIVE</div>
                <h3 x-text="event.title"></h3>
                <div>
                    <span x-show="event.livestream_available" class="badge livestream">ðŸŽ¥ Livestream</span>
                    <span x-show="event.zoom_available" class="badge zoom">Zoom</span>
                    <span x-show="event.cme_available" class="badge cme">CME</span>
                </div>
                <p class="institution" x-text="event.institution"></p>
                <p class="details">
                    <strong>When:</strong> <span x-text="formatDate(event.date_time)"></span><br>
                    <strong>Speaker:</strong> <span x-text="event.speaker || 'TBA'"></span><br>
                    <strong>Department:</strong> <span x-text="event.department || 'N/A'"></span><br>
                    <span x-show="event.format"><strong>Format:</strong> <span x-text="event.format"></span></span>
                </p>
                <div x-show="event.zoom_info" class="format-info">
                    <strong>ðŸ”— Access:</strong> <span x-text="event.zoom_info"></span>
                </div>
                <div x-show="event.notes" class="details" style="margin-top: 8px;">
                    <em x-text="event.notes"></em>
                </div>
                <p class="links" style="margin-top: 12px;">
                    <a :href="event.source_link" target="_blank" style="font-weight: bold;">ðŸ“… More Info & Schedule</a>
                </p>
            </div>
        </template>
        <div x-show="filteredEvents.length === 0">
            <p>No events found.</p>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Medical Grand Rounds - Nationwide Livestreaming</p>
        <p style="font-size: 0.85em; color: #666;">Last updated: <span x-text="new Date().toLocaleDateString()"></span></p>
    </footer>
</body>
</html>
