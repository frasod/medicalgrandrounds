<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New England Medical Grand Rounds</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 960px; margin: 20px auto; padding: 0 15px; }
        header, footer { text-align: center; margin-bottom: 20px; }
        .filters { background-color: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .filters select, .filters input { padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .event-card { border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .event-card h3 { margin-top: 0; }
        .event-card .institution { font-weight: bold; color: #555; }
        .event-card .details { font-size: 0.9em; color: #777; }
        .event-card .links a { margin-right: 15px; text-decoration: none; }
    </style>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="{
    events: [],
    loading: true,
    stateFilter: '',
    searchTerm: '',

    init() {
        fetch('data.json')
            .then(r => r.json())
            .then(d => {
                this.events = d.events || [];
                this.loading = false;
                console.log('Loaded', this.events.length, 'events');
            })
            .catch(e => {
                console.error('Error:', e);
                this.loading = false;
            });
    },

    formatDate(dateStr) {
        if (!dateStr) return 'Date TBA';

        // Handle recurring events
        if (dateStr.includes('Recurring') || dateStr.includes('Weekly') || dateStr.includes('Regular')) {
            return dateStr;
        }

        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;

            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
            const day = date.getDate();
            const suffix = day === 1 || day === 21 || day === 31 ? 'st' :
                          day === 2 || day === 22 ? 'nd' :
                          day === 3 || day === 23 ? 'rd' : 'th';

            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            const displayMinutes = minutes.toString().padStart(2, '0');

            return `${months[date.getMonth()]} ${day}${suffix}, ${date.getFullYear()} at ${displayHours}:${displayMinutes} ${ampm}`;
        } catch (e) {
            return dateStr;
        }
    },

    isWithinNextMonth(dateStr) {
        // Keep recurring events
        if (dateStr.includes('Recurring') || dateStr.includes('Weekly') || dateStr.includes('Regular')) {
            return true;
        }

        try {
            const eventDate = new Date(dateStr);
            if (isNaN(eventDate.getTime())) return true; // Keep if can't parse

            const now = new Date();
            const oneMonthFromNow = new Date();
            oneMonthFromNow.setMonth(oneMonthFromNow.getMonth() + 1);

            return eventDate >= now && eventDate <= oneMonthFromNow;
        } catch (e) {
            return true; // Keep if error parsing
        }
    },

    get filteredEvents() {
        let result = this.events;

        // Show only future events
        const now = new Date();
        result = result.filter(e => {
            const dt = e.date_time;
            // Always show recurring events
            if (dt.includes('Recurring') || dt.includes('Weekly') || dt.includes('Mondays') || 
                dt.includes('Fridays') || dt.includes('Thursdays') || dt.includes('Regular') || dt.includes('Contact')) {
                return true;
            }
            try {
                const eventDate = new Date(dt);
                return !isNaN(eventDate.getTime()) && eventDate >= now;
            } catch {
                return false;
            }
        });

        if (this.stateFilter) {
            result = result.filter(e => e.state === this.stateFilter);
        }

        if (this.searchTerm && this.searchTerm.length > 2) {
            const term = this.searchTerm.toLowerCase();
            result = result.filter(e =>
                (e.title && e.title.toLowerCase().includes(term)) ||
                (e.institution && e.institution.toLowerCase().includes(term)) ||
                (e.speaker && e.speaker.toLowerCase().includes(term))
            );
        }

        return result;
    },

    get states() {
        return [...new Set(this.events.map(e => e.state))].sort();
    }
}">
    <header>
        <h1>New England Medical Grand Rounds</h1>
        <p>Your hub for New England medical education schedules.</p>
    </header>

    <div class="filters">
        <select x-model="stateFilter">
            <option value="">All States</option>
            <template x-for="state in states">
                <option :value="state" x-text="state"></option>
            </template>
        </select>
        <input type="text" x-model="searchTerm" placeholder="Search...">
        <span x-text="'(' + filteredEvents.length + ' events)'"></span>
    </div>

    <div x-show="loading">Loading events...</div>

    <main x-show="!loading">
        <template x-for="event in filteredEvents" :key="event.title + event.date_time">
            <div class="event-card">
                <h3 x-text="event.title"></h3>
                <p class="institution" x-text="event.institution"></p>
                <p class="details">
                    <strong>When:</strong> <span x-text="formatDate(event.date_time)"></span><br>
                    <strong>Speaker:</strong> <span x-text="event.speaker || 'TBA'"></span><br>
                    <strong>Department:</strong> <span x-text="event.department || 'N/A'"></span>
                </p>
                <p class="links">
                    <a :href="event.source_link" target="_blank">More Info</a>
                    <span x-show="event.cme_available"> | <strong>CME Available</strong></span>
                </p>
            </div>
        </template>
        <div x-show="filteredEvents.length === 0">
            <p>No events found.</p>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 New England Medical Grand Rounds</p>
    </footer>
</body>
</html>
